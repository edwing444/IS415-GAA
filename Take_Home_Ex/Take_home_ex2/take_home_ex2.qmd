---
title: "Take Home Exercise 2: Application of Geospatial Analysis Methods to Discover Thailand Drug Abuse at the Province Level"
author: "edwin"
execute: 
  eval: true
  echo: true
  freeze: true
---

# Background

### 1. **Geopolitical Context**

-   Thailand's proximity to the **Golden Triangle** (the region where the borders of Thailand, Laos, and Myanmar meet) is significant as this area is historically known as a major hub for drug production and trafficking, particularly of opium and heroin. More recently, synthetic drugs like methamphetamine have become prevalent.

-   Thailand serves both as a **transit route** for drugs destined for third countries and as a significant **market** for illicit drugs. This geopolitical factor adds complexity to the issue, as it intersects with international drug trafficking networks and the nation's domestic drug use.

### 2. **Transportation Infrastructure**

-   With the continuous development of transportation infrastructure in Thailand, the movement of drugs becomes easier both within the country and across borders. This infrastructure facilitates not only legitimate commerce but also illegal activities, particularly in regions that border drug-producing areas.

-   Analysts should consider transportation routes and **connectivity** between provinces, as these might correlate with higher rates of drug abuse or trafficking activity in certain regions.

### 3. **Prevalence of Drug Use**

-   Globally, drug use is on the rise, and Thailand reflects this trend. With **2.7 million youths** reportedly using drugs, and **300,000** needing drug treatment, it’s clear that drug abuse is a pervasive social problem.

-   A particular focus should be placed on **youth involvement**, especially among **vocational-school students**, as they show a higher incidence of drug abuse compared to secondary-school students. Analysts may want to explore why this demographic is more vulnerable and how their environment (e.g., educational settings, social circles) contributes to the problem.

### 4. **Health, Financial, and Social Impact**

-   Drug abuse has severe **health consequences**, including addiction, overdose, and the spread of infectious diseases (e.g., HIV, hepatitis).

-   The **financial cost** includes both the economic burden on healthcare systems and the loss of productivity, particularly among the youth. Social consequences may include increased crime rates, family breakdowns, and reduced educational and employment opportunities for affected individuals.

-   **Social services** and the **healthcare system** in Thailand are likely under strain, with increasing demands for drug treatment and rehabilitation programs.

### 5. **Geographic Distribution of Drug Use**

-   By analyzing the **geographic distribution** of drug use cases across provinces, one can identify patterns that may suggest localized factors contributing to drug abuse. This may include proximity to trafficking routes, socio-economic disparities, or regional differences in enforcement or education.

-   Analysts should be prepared to look at this distribution in relation to **population density**, economic activity, access to healthcare, and law enforcement effectiveness. Yearly data will also allow for the identification of **trends over time**, such as regions where drug abuse is increasing or decreasing.

### 6. **Policy and Enforcement**

-   Thailand has a strong **anti-drug policy**, including harsh penalties for drug-related offenses. However, the effectiveness of these policies is debatable given the continued rise in drug use. An analyst should consider the impact of these policies, including whether they have driven drug abuse underground or led to unintended consequences, such as higher incarceration rates.

In analyzing this data, it is crucial to contextualize it within **regional geopolitics**, **infrastructure development**, **social factors**, and **government responses**. Mapping drug abuse cases by year and province can help to uncover hotspots, trends, and areas where intervention may be most needed. Understanding the **root causes** of drug abuse among vulnerable populations, particularly youths, is also essential in crafting effective policy recommendations and targeted interventions.

# Installing and loading R packages

```{r}

pacman::p_load(sf, spdep, tmap, tidyverse,sfdep)
```

-   **sf**: This package is used for handling spatial data in R, allowing for operations on simple features (geometric objects).

-   **spdep**: This package provides tools for spatial dependence, including functions for spatial weights and models.

-   **tmap**: A package designed for thematic mapping, making it easy to create static and interactive maps.

-   **tidyverse**: A collection of R packages designed for data science, including `ggplot2`, `dplyr`, and others that simplify data manipulation and visualization.

-   **sfdep**: This package focuses on spatial dependency, providing tools for estimating spatial autocorrelation and conducting related analyses.

# The data

```{r}
drug_data <- read.csv("data/thai_drug_offenses_2017_2022.csv")
```

read a CSV (Comma-Separated Values) file containing data on drug offenses in Thailand from the years 2017 to 2022. Here’s a breakdown of its components and purpose:

```{r}
summary(drug_data)
```

-   **Fiscal Year**:

    -   The `fiscal_year` variable ranges from **2017 to 2022**. This indicates that the dataset covers a total of **6 years** of drug offense data.

    -   The median year is **2020**, and the mean year is also **2020**, suggesting that the data is centered around this time period.

-   **Types of Drug Offenses**:

    -   The `types_of_drug_offenses` variable is categorical (character type) and contains a variety of different drug offenses.

    -   The distribution of types may be analyzed further to determine which types of offenses are most common over the years.

-   **Number of Cases (`no_cases`)**:

    -   The `no_cases` variable indicates the number of drug offense cases recorded in the dataset.

    -   **Minimum**: There are instances with **0 cases**, indicating that in some provinces or years, no drug offenses were reported.

    -   **1st Quartile**: The first quartile (25th percentile) shows that **25% of the cases** had **1 or fewer** offenses, indicating low numbers of cases in a substantial portion of the dataset.

    -   **Median**: The median of **70 cases** suggests that half of the entries reported **70 or fewer offenses**, highlighting a significant number of cases in the upper half.

    -   **Mean**: The average number of cases is **535.3**, which is considerably higher than the median, suggesting that there are some provinces or years with exceptionally high numbers of cases that skew the average upwards.

    -   **3rd Quartile**: The third quartile indicates that **75% of the cases** reported **623 or fewer offenses**, reflecting that a smaller portion of the dataset has a much larger number of offenses.

    -   **Maximum**: The maximum number of cases reported is **17,131**, which indicates a significant outlier. This could represent a specific province or year with particularly high drug offenses that may require further investigation.

-   **Province**:

    -   The `province_en` variable, also categorical, lists the provinces in which the drug offenses occurred. The length of this variable being **7392** indicates that there are multiple entries for different provinces and years.

    -   Analysis of this variable could reveal geographic patterns of drug offenses, helping identify regions that are more heavily impacted by drug issues.

Once the provincial boundaries are loaded into the `thailand_provinces` variable as a Simple Features (sf) object, it can be used for various analyse

```{r}
thailand_provinces<- st_read(dsn="data/geospatial",
                         layer = "tha_admbnda_adm1_rtsd_20220121")
```

```{r}
# Drop the ADM1_TH column
thailand_provinces <- thailand_provinces %>%
  select(-ADM1_TH,-ADM1_REF,-ADM1ALT1EN,-ADM1ALT2EN,-ADM1ALT1TH,-ADM1ALT2EN, -ADM1ALT2TH, -ADM0_TH) %>% 
  rename(province_en = ADM1_EN)

# Drop the province_th column
drug_data <- drug_data %>%
  select(-province_th)
```

I simplify the `thailand_provinces` dataset by removing columns that are not needed for further analysis, thus making the dataset cleaner and more manageable. Also, i rename the `ADM1_EN` column to `province_en`, which contains the province names in English. This provides a clearer and more intuitive column name for future analysis.\
\
Next, I remove the `province_th` column from the `drug_data` dataset, likely because it contains redundant or unnecessary information, especially if the `thailand_provinces` dataset now includes the relevant province information in English. Dropping this column helps streamline the `drug_data` dataset, focusing on the necessary columns that are crucial for the analysis of drug offenses.

```{r}
province_grouped <- drug_data %>%
  group_by(fiscal_year, province_en)

# Example: Summarize the total drug offenses for each group
province_summary <- province_grouped %>%
  summarise(total_offenses = sum(no_cases, na.rm = TRUE), .groups = "keep")
```

This grouping allows for subsequent calculations to be performed within these groups, making it easier to analyze trends and patterns of drug offenses over time and across different provinces.

The result after summarising is a new data frame `province_summary` that contains three columns: `fiscal_year`, `province_en`, and `total_offenses`, which reflects the total number of offenses recorded for each province in each fiscal year.

The argument `.groups = "keep"` retains the grouping structure of the original data frame in the summarized output, which may be useful for further analysis or visualizations.

```{r}
# Join the drug abuse data with province polygons
combined_data <- thailand_provinces %>%
  left_join(drug_data, by = "province_en")

```

Now I will merge the two datasets in a way that retains all the rows from the `thailand_provinces` dataset and includes matching rows from the `drug_data` dataset based on the `province_en` column.

-   If a province in `thailand_provinces` does not have corresponding data in `drug_data`, the resulting `combined_data` will still include that province, but the columns from `drug_data` will contain `NA` (missing values).

The purpose of this operation is to create a combined dataset that integrates geographic information about the provinces with the corresponding drug offense data. This integration is used for mapping the data to **understand how the data looks like**

```{r}
# Join the drug abuse province data with province polygons
combined_province_data <- thailand_provinces %>%
  left_join(province_summary)
```

The above merges the geographic data of provinces with the summarized drug offense data to create a comprehensive dataset that includes both spatial and analytical information.

-   The join is done based on the common columns present in both datasets. Since `province_summary` is assumed to have the `province_en` column, it will merge the summarized drug offense totals for each province.

-   If there are provinces in `thailand_provinces` that do not have corresponding entries in `province_summary`, they will still be included in the resulting dataset (`combined_province_data`), but the columns from `province_summary` will contain `NA` (missing values).

This integration is essential for **spatial analysis and for visualizing the data on maps**.

```{r}
combined_province_data <- combined_province_data %>%
  filter(!is.na(total_offenses))
```

Now I clean the dataset by excluding any entries that do not have a valid total number of drug offenses.

Removing rows with `NA` values in the `total_offenses` column ensures that subsequent analyses or visualizations are based on complete data, leading to more accurate and reliable results.

```{r}
print(st_geometry_type(combined_province_data))
```

It is "MULTIPOLYGON", it signifies that some provinces may consist of multiple, non-contiguous areas.

```{r}
# Create a choropleth map using tmap
tm_shape(combined_province_data) +
  tm_polygons("total_offenses", 
              title = "Number of Cases",
              palette = "Blues", 
              style = "quantile", 
              n = 5) +
  tm_facets(by = "fiscal_year", nrow = 2, free.coords = FALSE) +
  tm_layout(main.title = "Drug Offense Cases in Thailand by Province and Fiscal Year",
            main.title.size = 1.5,
            legend.outside = TRUE)
```

**Key Observations:**

1.  **Spatial Distribution:**

    -   **Northern Thailand:** Consistently shows higher rates of drug offenses throughout the depicted years.

    -   **Southern Thailand:** Exhibits a mix of high and low rates, with some provinces experiencing significant spikes in certain years.

    -   **Central Thailand:** Generally has lower rates compared to the north and south, though there are fluctuations.

2.  **Temporal Trends:**

    -   **2017-2019:** A general increase in drug offense cases is observed across most provinces.

    -   **2020:** A slight decrease is seen in some regions, potentially due to COVID-19 restrictions or other factors.

    -   **2021-2022:** Data is missing for 2022, making a complete analysis difficult. However, 2021 shows a continuation of trends from previous years.

3.  **Hotspots:**

    -   **Northern Provinces:** Chiang Mai, Chiang Rai, and Mae Hong Son consistently appear as hotspots with high levels of drug offenses.

    -   **Southern Provinces:** Provinces like Yala, Pattani, and Narathiwat often show elevated rates, particularly in certain years.

**Potential Explanations and Further Analysis:**

-   **Geographical Factors:** Proximity to borders with neighboring countries, especially Myanmar and Laos, could influence drug trafficking routes and hence, higher rates of offenses.

-   **Socioeconomic Conditions:** Poverty, unemployment, and lack of educational opportunities might be contributing factors in regions with high rates.

-   **Governance and Law Enforcement:** The effectiveness of law enforcement agencies and anti-drug initiatives could vary across different regions.

-   **Drug Production and Trafficking:** Understanding the specific types of drugs involved and their production/trafficking routes could provide valuable insights.

```{r}
# Example: KDE (if you have point data)
tm_shape(combined_province_data) +
  tm_polygons("total_offenses", 
              title = "Number of Drug Cases", 
              palette = "Oranges", 
              style = "cont") +  # Continuous color scale
  tm_layout(main.title = "KDE Map of Drug Offense Density", 
            legend.outside = TRUE)
```

**Key Observations:**

1.  **Spatial Clustering:**

    -   **Northern Thailand:** Exhibits the highest density of drug offenses, with clusters forming in regions like Chiang Mai, Chiang Rai, and Mae Hong Son.

    -   **Southern Thailand:** Also shows significant clustering, particularly in the provinces of Yala, Pattani, and Narathiwat.

    -   **Central Thailand:** Generally has lower densities, with scattered clusters in some areas.

2.  **Density Gradients:**

    -   The map clearly illustrates gradients in drug offense density, with darker shades indicating higher concentrations and lighter shades representing lower concentrations.

    -   These gradients provide a visual representation of the spatial distribution of drug offenses across the country.

**Potential Explanations and Further Analysis:**

-   **Geographical Factors:** Proximity to borders with neighboring countries, such as Myanmar and Laos, could influence drug trafficking routes and contribute to higher densities in those regions.

-   **Socioeconomic Conditions:** Poverty, unemployment, and lack of educational opportunities might be correlated with higher drug offense rates.

-   **Governance and Law Enforcement:** The effectiveness of law enforcement agencies and anti-drug initiatives could vary across different regions, impacting the density of drug offenses.

-   **Drug Production and Trafficking:** Understanding the specific types of drugs involved and their production/trafficking routes could provide valuable insights into the spatial patterns.

```{r}
# Create neighbors list
neighbors <- st_contiguity(combined_province_data)
```

```{r}
wm_t <- poly2nb(thailand_provinces, 
                queen=TRUE)
```

```{r}
summary(wm_t)
```

```{r}
rswm_t <- nb2listw(wm_t, 
                   style="W", 
                   zero.policy = TRUE)
rswm_t
```

```{r}
length(combined_province_data$total_offenses)  # Check the length of your data
length(neighbors)  # Check the number of units in the spatial weights matrix
```

```{r}
#moran.test(combined_province_data$total_offenses,listw=neighbors, 
           #zero.policy = TRUE, 
           #na.action=na.omit)
```

```{r}
listw <- nb2listw(neighbors)
```

```{r}
summary(listw)
```

```{r}
# Convert neighbors list to weights list
weights_list <- nb2listw(neighbors, style = "W")
```

```{r}
# Calculate Moran's I
moran_result <- moran.test(combined_province_data$total_offenses, listw)
print(moran_result)
```

```{r}
wm_thai_g <- combined_province_data %>% 
  mutate(nb=st_contiguity(geometry),
         wt=st_weights(nb,
                       style="W"),
         .before = 1)
```

```{r}
moranI <- global_moran(wm_thai_g$total_offenses,
                       wm_thai_g$nb,
                       wm_thai_g$wt)
glimpse(moranI)
```

```{r}
global_moran_test(wm_thai_g$total_offenses,
                       wm_thai_g$nb,
                       wm_thai_g$wt)
```

```{r}
global_moran_perm(wm_thai_g$total_offenses,
                       wm_thai_g$nb,
                       wm_thai_g$wt,
                  nsim = 99)
```

```{r}
# Local Moran's I (LISA) calculation
local_moran <- localmoran(combined_province_data$total_offenses, listw)
head(local_moran)
```

```{r}
# Local Moran's I (LISA) calculation
lisa <- localmoran(combined_province_data$total_offenses, listw = weights_list)
combined_province_data$lisa <- lisa[, "Ii"] 
```

```{r}
# Set tmap mode to interactive or static
tmap_mode("plot")  # Use "view" for interactive

# Create a thematic map to visualize Local Moran's I
tm_shape(combined_province_data) +
  tm_polygons("lisa", palette = "viridis", title = "Local Moran's I (LISA)") +
  tm_layout(title = "Local Moran's I (LISA) for Drug Abuse in Thailand Provinces")
```

```{r}
lisa <- wm_thai_g %>% 
  mutate(local_moran = local_moran(
    total_offenses,nb,wt,nsim=99),
    .before=1) %>% 
  unnest(local_moran)
```

```{r}
tmap_mode('plot')
map1 <- tm_shape(lisa)+
  tm_fill('ii')+
  tm_borders(alpha=0.5)+
  tm_view(set.zoom.limits = c(5,8))+
  tm_layout(
    main.title = "local Moran's I of G",
    main.title.size = 2
  )

map2 <- tm_shape(lisa)+
  tm_fill('p_ii',
          breaks = c(0,0.001,0.01,0.05,1),
          labels = c("0.001","0.01","0.05","Not Sig"))+
  tm_borders(alpha=0.5)+
  tm_layout(
    main.title = "p=value of local Moran's I ",
    main.title.size = 0.8
  )
tmap_arrange(map1,map2,ncol=2)
```

```{r}
lisa_sig <- lisa %>% 
  filter(p_ii < 0.05)

tmap_mode("plot")
tm_shape(lisa)+
  tm_polygons()+
  tm_borders(alpha=0.5)+
  tm_shape(lisa_sig)+
  tm_fill("mean")+
  tm_borders(alpha=0.4)
```

```{r}
geary.test(combined_province_data$total_offenses, listw=weights_list)
```

```{r}
set.seed(1234)
bperm_GC=geary.mc(combined_province_data$total_offenses, 
               listw=weights_list, 
               nsim=999)
bperm_GC
```

```{r}
hist(bperm_GC$res, freq=TRUE, breaks=20, xlab="Simulated Geary c")
abline(v=1, col="red") 
```

```{r}
set.seed(1234)
bperm= moran.mc(combined_province_data$total_offenses, 
                listw=weights_list, 
                nsim=999, 
                zero.policy = TRUE, 
                na.action=na.omit)
bperm
```

```{r}
mean(bperm$res[1:999])
```

```{r}
hist(bperm$res, 
     freq=TRUE, 
     breaks=20, 
     xlab="Simulated Moran's I")
abline(v=0, 
       col="red") 
```

```{r}
province.localMI <- cbind(combined_province_data,local_moran) %>%
  rename(Pr.Ii = Pr.z....E.Ii..)
```

```{r}
tm_shape(province.localMI) +
  tm_fill(col = "Ii", 
          style = "pretty",
          palette = "RdBu",
          title = "local moran statistics") +
  tm_borders(alpha = 0.5)
```

```{r}
wm_thai <- combined_province_data %>% 
  mutate(nb=st_contiguity(geometry),
         wts = st_inverse_distance(nb,geometry,
                                   scale=1,
                                   alpha=1),
         .before = 1)
```

```{r}
HCSA <- wm_thai %>% 
  mutate(local_Gi = local_gstar_perm(
    total_offenses,nb,wt,nsim=99),
    .before=1) %>% 
      unnest(local_Gi)
```

```{r}
HCSA_sig <- HCSA %>% 
  filter(p_sim<0.05)
tmap_mode("plot")
tm_shape(HCSA)+
  tm_polygons()+
  tm_borders(alpha=0.5)+
tm_shape(HCSA_sig)+
  tm_fill("gi_star")+
  tm_borders(alpha=0.4)
```
