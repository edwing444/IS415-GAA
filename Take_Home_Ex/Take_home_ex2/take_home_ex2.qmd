---
title: "Take Home Exercise 2"
author: "edwin"
execute: 
  eval: true
  echo: true
  freeze: true
---

# Installing and loading R packages

```{r}
pacman::p_load(sf, spdep, tmap, tidyverse,sfdep)
```

# The data

```{r}
drug_data <- read.csv("data/thai_drug_offenses_2017_2022.csv")
```

```{r}
thailand_provinces<- st_read(dsn="data/geospatial",
                         layer = "tha_admbnda_adm1_rtsd_20220121")
```

```{r}
# Drop the ADM1_TH column
thailand_provinces <- thailand_provinces %>%
  select(-ADM1_TH,ADM1_REF,ADM1ALT1EN,ADM1ALT2EN,ADM1ALT1TH,ADM1ALT2EN) %>% 
  rename(province_en = ADM1_EN)

# Drop the province_th column
drug_data <- drug_data %>%
  select(-province_th)
```

```{r}
drug_data_grouped <- drug_data %>%
  group_by(fiscal_year, province_en)

# Example: Summarize the total drug offenses for each group
drug_data_summary <- drug_data_grouped %>%
  summarise(total_offenses = sum(no_cases, na.rm = TRUE), .groups = "keep")
```

```{r}
# Join the drug abuse data with province polygons
combined_data <- thailand_provinces %>%
  left_join(drug_data_summary, by = "province_en")

```

```{r}
print(st_geometry_type(combined_data))
```

```{r}
ggplot(combined_data) +
  geom_sf(aes(fill = total_offenses), color = "black") +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Drug Offense Cases in Thailand by Province",
       fill = "Number of Cases") +
  facet_wrap(~ fiscal_year) +  # Create separate maps for each fiscal year
  theme_minimal()
```

```{r}
# Create a choropleth map using tmap
tm_shape(combined_data) +
  tm_polygons("total_offenses", 
              title = "Number of Cases",
              palette = "Blues", 
              style = "quantile", 
              n = 5) +
  tm_facets(by = "fiscal_year", nrow = 2, free.coords = FALSE) +
  tm_layout(main.title = "Drug Offense Cases in Thailand by Province and Fiscal Year",
            main.title.size = 1.5,
            legend.outside = TRUE)
```

```{r}
# Example: KDE (if you have point data)
tm_shape(combined_data) +
  tm_polygons("total_offenses", 
              title = "Number of Drug Cases", 
              palette = "Oranges", 
              style = "cont") +  # Continuous color scale
  tm_layout(main.title = "KDE Map of Drug Offense Density", 
            legend.outside = TRUE)
```
